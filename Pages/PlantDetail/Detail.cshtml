@page "/PlantDetail/Detail/{id}"
@model Plantpedia.Pages.Plant.DetailsModel
@using System.Security.Claims

@{
    ViewData["Title"] = "Chi tiết cây trồng";
}

@Html.AntiForgeryToken()

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="~/css/detail-page.css" asp-append-version="true" />
}

<main class="container my-5">
    <!-- Error Alert -->
    <div id="errorAlert" class="alert alert-danger d-none" role="alert">
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorMessage"></span>
    </div>

    <!-- Plant Content -->
    <div id="plantContent" class="d-none">
        <div class="row">
            <!-- Image Gallery -->
            <div class="col-lg-6 mb-4">
                <!-- Breadcrumb moved here, top left of gallery -->
                <nav aria-label="breadcrumb" class="mb-0">
                    <ol class="breadcrumb bg-transparent p-0">
                        <li class="breadcrumb-item">
                            <a asp-page="/Home/Home" class="text-success">
                                <i class="fas fa-home"></i> Trang chủ
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a asp-page="/Home/Search" class="text-success">Cây trồng</a>
                        </li>
                        <li class="breadcrumb-item active" id="breadcrumbName">Chi tiết</li>
                    </ol>
                </nav>

                <div class="card shadow-sm border-0">
                    <div class="card-body p-3">
                        <img id="mainImage" src="#" class="img-fluid rounded main-image" alt="Ảnh chính">
                    </div>
                </div>
                <div id="thumbnailContainer" class="row g-2 mt-2"></div>
            </div>

            <!-- Plant Information -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body p-4">
                        <h1 id="plantCommonName" class="h2 fw-bold text-dark mb-2"></h1>
                        <p class="text-muted fst-italic mb-3">
                            <i class="fas fa-flask"></i>
                            <span id="plantScientificName"></span>
                        </p>

                        <div id="badgesContainer" class="mb-4"></div>

                        <div class="description-box p-3 bg-light rounded mb-4">
                            <h5 class="text-success mb-3">
                                <i class="fas fa-info-circle"></i> Mô tả
                            </h5>
                            <p id="plantDescription" class="mb-0"></p>
                        </div>

                        <div id="quickInfoContainer" class="row g-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="card shadow-sm border-0 mt-4">
            <div class="card-header bg-white border-0">
                <ul class="nav nav-tabs card-header-tabs" id="plantTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="careTab" data-bs-toggle="tab" data-bs-target="#care"
                            type="button" role="tab">
                            <i class="fas fa-hand-holding-water"></i> Chăm sóc
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="regionTab" data-bs-toggle="tab" data-bs-target="#region"
                            type="button" role="tab">
                            <i class="fas fa-map-marked-alt"></i> Vùng trồng
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="soilTab" data-bs-toggle="tab" data-bs-target="#soil" type="button"
                            role="tab">
                            <i class="fas fa-layer-group"></i> Loại đất
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="climateTab" data-bs-toggle="tab" data-bs-target="#climate"
                            type="button" role="tab">
                            <i class="fas fa-cloud-sun"></i> Khí hậu
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="usageTab" data-bs-toggle="tab" data-bs-target="#usage"
                            type="button" role="tab">
                            <i class="fas fa-utensils"></i> Mục đích
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="plantTabsContent">
                    <div class="tab-pane fade show active" id="care" role="tabpanel">
                        <h5 class="text-success mb-4">
                            <i class="fas fa-spa"></i> Hướng dẫn chăm sóc chi tiết
                        </h5>
                        <dl id="careList" class="row mb-0"></dl>
                    </div>
                    <div class="tab-pane fade" id="region" role="tabpanel">
                        <h5 class="text-success mb-3">
                            <i class="fas fa-globe-asia"></i> Vùng trồng phù hợp
                        </h5>
                        <div id="regionContent"></div>
                    </div>
                    <div class="tab-pane fade" id="soil" role="tabpanel">
                        <h5 class="text-success mb-3">
                            <i class="fas fa-mountain"></i> Loại đất thích hợp
                        </h5>
                        <div id="soilContent"></div>
                    </div>
                    <div class="tab-pane fade" id="climate" role="tabpanel">
                        <h5 class="text-success mb-3">
                            <i class="fas fa-temperature-high"></i> Khí hậu phù hợp
                        </h5>
                        <div id="climateContent"></div>
                    </div>
                    <div class="tab-pane fade" id="usage" role="tabpanel">
                        <h5 class="text-success mb-3">
                            <i class="fas fa-tasks"></i> Mục đích sử dụng
                        </h5>
                        <div id="usageContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <section class="mt-5" data-plant-id="@Model.PlantId">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <h4 class="mb-4">
                        <i class="fas fa-comments text-success"></i> Bình luận
                    </h4>

                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <div class="card bg-light border-0 mb-4">
                            <div class="card-body">
                                <h5 class="mb-3">
                                    <i class="fas fa-pencil-alt text-success"></i>
                                    Viết bình luận
                                </h5>
                                <textarea id="commentContent" class="form-control mb-3" rows="4"
                                placeholder="Chia sẻ ý kiến, kinh nghiệm của bạn về cây trồng này..."></textarea>
                                <div id="commentError" class="alert alert-danger d-none" role="alert"></div>
                                <button id="btnSubmitComment" class="btn btn-success" type="button">
                                    <i class="fas fa-paper-plane"></i> Gửi bình luận
                                </button>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="card bg-light border-0 mb-4">
                            <div class="card-body text-center py-5">
                                <i class="fas fa-lock fa-3x text-success mb-3"></i>
                                <h5 class="mb-3">Đăng nhập để bình luận</h5>
                                <p class="text-muted mb-4">
                                    Vui lòng đăng nhập để chia sẻ ý kiến và trao đổi với cộng đồng
                                </p>
                                <a href="@(ViewData["LoginUrl"] as string ?? "#")" class="btn btn-success">
                                    <i class="fas fa-sign-in-alt"></i> Đăng nhập ngay
                                </a>
                            </div>
                        </div>
                    }

                    <div id="commentList"></div>
                </div>
            </div>
        </section>

        <template id="commentTemplate">
            <div class="comment-item">
                <div class="d-flex">
                    <!-- Avatar -->
                    <div class="comment-avatar flex-shrink-0">
                        <img src="" alt="Avatar" class="rounded-circle">
                        <i class="fa fa-user-circle"></i>
                    </div>

                    <!-- Nội dung bình luận -->
                    <div class="comment-body flex-grow-1 ms-2">
                        <div class="comment-bubble">
                            <div class="comment-content-wrapper">
                                <a href="#" class="comment-author text-dark fw-bold text-decoration-none"></a>
                                <span class="comment-text"></span>

                                <!-- NÚT 3 CHẤM ĐÃ DI CHUYỂN VÀO ĐÂY -->
                                <div class="comment-options-dropdown dropdown">
                                    <button class="btn btn-sm btn-light py-0 px-2 rounded-circle" type="button"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-three-dots"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item btn-edit" href="#"><i
                                                    class="bi bi-pencil-square me-2"></i>Chỉnh sửa</a></li>
                                        <li><a class="dropdown-item btn-delete text-danger" href="#"><i
                                                    class="bi bi-trash me-2"></i>Xóa</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Actions: Like, Reply, Time -->
                        <div class="comment-actions small d-flex align-items-center mt-2">
                            <a href="#" class="btn-react fw-bold text-decoration-none">
                                <i class="bi bi-heart"></i>
                                <span>Thích</span>
                            </a>
                            <a href="#" class="btn-reply fw-bold text-decoration-none text-muted"><i
                                    class="bi bi-chat-left-text me-1"></i>Trả lời</a>
                            <small class="comment-date text-muted"></small>
                            <span class="react-display ms-2">
                                <i class="bi bi-heart-fill text-danger"></i>
                                <span class="react-count">0</span>
                            </span>
                        </div>

                        <div class="dynamic-form-container mt-2"></div>
                    </div>
                </div>
                <div class="reply-list-container"></div>
            </div>
        </template>
    </div>
</main>


@section Scripts {
    <script>window.currentUserId = '@User.FindFirstValue(ClaimTypes.NameIdentifier)';</script>
    <script type="module" src="~/js/main-detail-page.js" asp-append-version="true"></script>
    <script type="module" src="~/js/main-comment.js" asp-append-version="true"></script>
}