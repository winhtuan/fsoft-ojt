@page "/PlantDetail/Detail/{id}"
@model Plantpedia.Pages.Plant.DetailsModel
@using Plantpedia.Helper

@{
    ViewData["Title"] = "Chi ti·∫øt c√¢y tr·ªìng";
}
@section Styles {
    <link rel="stylesheet" href="~/css/detail-page.css" asp-append-version="true" />
}
<main class="container my-5">
    <div class="row">
        <!-- C·ªôt b√™n tr√°i: H√¨nh ·∫£nh s·∫£n ph·∫©m -->
        <div class="col-lg-6">
            @if (Model.Plant.ImageUrls != null && Model.Plant.ImageUrls.Any())
            {
                <!-- ·∫¢nh ch√≠nh -->
                <div class="mb-3">
                    <img id="mainPlantImage" src="@Model.Plant.ImageUrls.First()" class="img-fluid rounded shadow-sm w-100"
                        alt="H√¨nh ·∫£nh ch√≠nh c·ªßa @Model.Plant.CommonName">
                </div>
                <!-- Danh s√°ch ·∫£nh nh·ªè (thumbnail) -->
                <div class="row g-2">
                    @foreach (var imageUrl in Model.Plant.ImageUrls)
                    {
                        <div class="col-3">
                            <img src="@imageUrl"
                                class="img-fluid rounded thumbnail-image @(imageUrl == Model.Plant.ImageUrls.First() ? "active" : "")"
                                alt="H√¨nh ·∫£nh chi ti·∫øt c·ªßa @Model.Plant.CommonName">
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="mb-3">
                    <img id="mainPlantImage" src="~/images/placeholder.png" class="img-fluid rounded shadow-sm w-100"
                        alt="Ch∆∞a c√≥ h√¨nh ·∫£nh">
                </div>
            }
        </div>

        <!-- C·ªôt b√™n ph·∫£i: Th√¥ng tin chi ti·∫øt -->
        <div class="col-lg-6">
            <h3 class="display-5 ps-2">@Model.Plant.CommonName</h3>
            <p class="text-muted fst-italic mb-3 ps-2"><strong>T√™n khoa h·ªçc:</strong> @Model.Plant.ScientificName</p>

            <h4 class="ps-2">M√¥ t·∫£ chi ti·∫øt</h4>
            <p class="ps-2">
                @Model.Plant.Description
            </p>

            @if (!string.IsNullOrEmpty(Model.Plant.PlantTypeName))
            {
                <p class="ps-2"><strong>Lo·∫°i c√¢y:</strong> <span class="badge bg-success fs-6">@Model.Plant.PlantTypeName</span></p>
            }

            <p class="ps-2">
                <strong>Th·ªùi gian thu ho·∫°ch:</strong>
                @if (Model.Plant.HarvestDate.HasValue && Model.Plant.HarvestDate > 0)
                {
                    <span>Sau @Model.Plant.HarvestDate ng√†y</span>
                }
                else
                {
                    <span class="text-muted">Kh√¥ng √°p d·ª•ng</span>
                }
            </p>
        </div>
<hr class="my-5" />

<section id="commentSection" class="mt-5">
  <h4 class="mb-4">B√¨nh lu·∫≠n</h4>

  <!-- Form t·∫°o b√¨nh lu·∫≠n -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3">Vi·∫øt b√¨nh lu·∫≠n</h5>
      <div class="mb-3">
        <textarea id="commentContent" class="form-control" rows="3" placeholder="Chia s·∫ª √Ω ki·∫øn c·ªßa b·∫°n..."></textarea>
      </div>
      <button id="btnCreateComment" class="btn btn-success px-4">G·ª≠i</button>
    </div>
  </div>

  <!-- Danh s√°ch b√¨nh lu·∫≠n -->
  <div id="commentList" class="comment-list"></div>
</section>

</section>
    <!-- Ph·∫ßn th√¥ng tin b·ªï sung ·ªü d∆∞·ªõi - D·∫°ng Tab -->
    <hr class="my-5">

    <div class="product-details-tabs">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs nav-fill" id="plantInfoTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="care-tab" data-bs-toggle="tab" data-bs-target="#care-tab-pane"
                    type="button" role="tab" aria-controls="care-tab-pane" aria-selected="true">
                    <i class="fas fa-hand-holding-water me-2"></i>ChƒÉm s√≥c
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="region-tab" data-bs-toggle="tab" data-bs-target="#region-tab-pane"
                    type="button" role="tab" aria-controls="region-tab-pane" aria-selected="false">
                    <i class="fas fa-map-marked-alt me-2"></i>V√πng tr·ªìng
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="soil-tab" data-bs-toggle="tab" data-bs-target="#soil-tab-pane"
                    type="button" role="tab" aria-controls="soil-tab-pane" aria-selected="false">
                    <i class="fas fa-seedling me-2"></i>Lo·∫°i ƒë·∫•t
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="climate-tab" data-bs-toggle="tab" data-bs-target="#climate-tab-pane"
                    type="button" role="tab" aria-controls="climate-tab-pane" aria-selected="false">
                    <i class="fas fa-cloud-sun me-2"></i>Kh√≠ h·∫≠u
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="usage-tab" data-bs-toggle="tab" data-bs-target="#usage-tab-pane"
                    type="button" role="tab" aria-controls="usage-tab-pane" aria-selected="false">
                    <i class="fas fa-bullseye me-2"></i>M·ª•c ƒë√≠ch s·ª≠ d·ª•ng
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content bg-white p-4 border border-top-0 rounded-bottom shadow-sm" id="plantInfoTabContent">

            <!-- N·ªôi dung Tab ChƒÉm s√≥c -->
            <div class="tab-pane fade show active" id="care-tab-pane" role="tabpanel" aria-labelledby="care-tab"
                tabindex="0">
                <h5>H∆∞·ªõng d·∫´n ChƒÉm s√≥c chi ti·∫øt</h5>
                <dl class="row">
                    <dt class="col-sm-4">Y√™u c·∫ßu √°nh s√°ng</dt>
                    <dd class="col-sm-8">
                        @EnumHelper.GetDisplayName(Model.Plant.LightRequirement)
                    </dd>
                    <dt class="col-sm-4">Nhu c·∫ßu t∆∞·ªõi n∆∞·ªõc</dt>
                    <dd class="col-sm-8">
                        @EnumHelper.GetDisplayName(Model.Plant.WateringNeeds)
                    </dd>
                    <dt class="col-sm-4">ƒê·ªô ·∫©m ∆∞a th√≠ch</dt>
                    <dd class="col-sm-8">
                        @EnumHelper.GetDisplayName(Model.Plant.HumidityPreference)
                    </dd>
                    <dt class="col-sm-4">T·ªëc ƒë·ªô tƒÉng tr∆∞·ªüng</dt>
                    <dd class="col-sm-8">
                        @EnumHelper.GetDisplayName(Model.Plant.GrowthRate)
                    </dd>
                    <dt class="col-sm-4">Lo·∫°i ƒë·∫•t ƒë·ªÅ xu·∫•t</dt>
                    <dd class="col-sm-8">@Model.Plant.SoilRecommendation</dd>
                    <dt class="col-sm-4">Th√¥ng tin b√≥n ph√¢n</dt>
                    <dd class="col-sm-8">@Model.Plant.FertilizerInfo</dd>
                </dl>
            </div>

            <!-- N·ªôi dung Tab V√πng tr·ªìng -->
            <div class="tab-pane fade" id="region-tab-pane" role="tabpanel" aria-labelledby="region-tab" tabindex="0">
                <h5>Khu v·ª±c tr·ªìng ph√π h·ª£p</h5>
                @if (Model.Plant.RegionNames != null && Model.Plant.RegionNames.Any())
                {
                    <ul>
                        @foreach (var item in Model.Plant.RegionNames)
                        {
                            <li>@item</li>
                        }
                    </ul>
                }
                else
                {
                    <p>Ch∆∞a c√≥ th√¥ng tin.</p>
                }
            </div>

            <!-- N·ªôi dung Tab Lo·∫°i ƒë·∫•t -->
            <div class="tab-pane fade" id="soil-tab-pane" role="tabpanel" aria-labelledby="soil-tab" tabindex="0">
                <h5>Lo·∫°i ƒë·∫•t ph√π h·ª£p</h5>
                @if (Model.Plant.SoilNames != null && Model.Plant.SoilNames.Any())
                {
                    <ul>
                        @foreach (var item in Model.Plant.SoilNames)
                        {
                            <li>@item</li>
                        }
                    </ul>
                }
                else
                {
                    <p>Ch∆∞a c√≥ th√¥ng tin.</p>
                }
            </div>

            <!-- N·ªôi dung Tab Kh√≠ h·∫≠u -->
            <div class="tab-pane fade" id="climate-tab-pane" role="tabpanel" aria-labelledby="climate-tab" tabindex="0">
                <h5>ƒêi·ªÅu ki·ªán kh√≠ h·∫≠u</h5>
                @if (Model.Plant.ClimateNames != null && Model.Plant.ClimateNames.Any())
                {
                    <ul>
                        @foreach (var item in Model.Plant.ClimateNames)
                        {
                            <li>@item</li>
                        }
                    </ul>
                }
                else
                {
                    <p>Ch∆∞a c√≥ th√¥ng tin.</p>
                }
            </div>

            <!-- N·ªôi dung Tab M·ª•c ƒë√≠ch s·ª≠ d·ª•ng -->
            <div class="tab-pane fade" id="usage-tab-pane" role="tabpanel" aria-labelledby="usage-tab" tabindex="0">
                <h5>M·ª•c ƒë√≠ch s·ª≠ d·ª•ng ch√≠nh</h5>
                @if (Model.Plant.UsageNames != null && Model.Plant.UsageNames.Any())
                {
                    <ul>
                        @foreach (var item in Model.Plant.UsageNames)
                        {
                            <li>@item</li>
                        }
                    </ul>
                }
                else
                {
                    <p>Ch∆∞a c√≥ th√¥ng tin.</p>
                }
            </div>

        </div> <!-- Th·∫ª ƒë√≥ng c·ªßa .tab-content ƒë√£ ƒë∆∞·ª£c di chuy·ªÉn ƒë·∫øn ƒë√¢y -->
    </div>
</main>

@section Scripts {
    <!-- JS cho th∆∞ vi·ªán ·∫£nh -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const mainImage = document.getElementById('mainPlantImage');
            const thumbnails = document.querySelectorAll('.thumbnail-image');

            if (mainImage && thumbnails.length > 0) {
                thumbnails.forEach(thumb => {
                    thumb.addEventListener('click', function () {
                        mainImage.src = this.src;
                        mainImage.alt = this.alt;
                        thumbnails.forEach(innerThumb => innerThumb.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
            }
        });
    </script>

    <!-- JS cho b√¨nh lu·∫≠n (AJAX kh√¥ng reload trang) -->
    <script>
    document.addEventListener("DOMContentLoaded", () => {
      const plantId = "@Model.Plant.PlantId";
      const apiBase = "/api/comment";
      const listEl = document.getElementById("commentList");
      const btnCreate = document.getElementById("btnCreateComment");
      const txtContent = document.getElementById("commentContent");
      const CURRENT_USER_ID = 1; // TODO: l·∫•y t·ª´ session/identity

      async function fetchJson(url, options) {
        const res = await fetch(url, options);
        return await res.json();
      }

      function renderComment(cmt, depth = 0) {
        const pad = Math.min(depth * 24, 72);
        const li = document.createElement("div");
        li.className = "card mb-2";
        li.style.marginLeft = pad + "px";
        li.innerHTML = `
          <div class="card-body py-3">
            <div class="d-flex justify-content-between">
              <div>
                <strong>${cmt.userName}</strong>
                <span class="text-muted small ms-2">${new Date(cmt.createdAt).toLocaleString()}</span>
              </div>
              <div class="text-muted small">
                <button class="btn btn-sm btn-outline-secondary me-2 btn-like" data-id="${cmt.commentId}" data-type="L">üëç ${cmt.likeCount}</button>
                <button class="btn btn-sm btn-outline-secondary btn-dislike" data-id="${cmt.commentId}" data-type="D">üëé ${cmt.dislikeCount}</button>
              </div>
            </div>
            <div class="mt-2">${cmt.content}</div>
            <div class="mt-2">
              <button class="btn btn-sm btn-link p-0 text-decoration-none btn-reply" data-id="${cmt.commentId}">Tr·∫£ l·ªùi</button>
              <div class="reply-form mt-2 d-none">
                <textarea class="form-control mb-2 reply-content" rows="2" placeholder="Nh·∫≠p n·ªôi dung tr·∫£ l·ªùi..."></textarea>
                <button class="btn btn-sm btn-primary btn-send-reply" data-parent="${cmt.commentId}">G·ª≠i</button>
              </div>
            </div>
          </div>
        `;

        li.querySelector(".btn-like").addEventListener("click", () => react(cmt.commentId, 'L'));
        li.querySelector(".btn-dislike").addEventListener("click", () => react(cmt.commentId, 'D'));

        li.querySelector(".btn-reply").addEventListener("click", () => {
          li.querySelector(".reply-form").classList.toggle("d-none");
        });

        li.querySelector(".btn-send-reply").addEventListener("click", async (e) => {
          const parentId = Number(e.currentTarget.getAttribute("data-parent"));
          const content = li.querySelector(".reply-content").value.trim();
          if (!content) { alert("Vui l√≤ng nh·∫≠p n·ªôi dung."); return; }

          const payload = { plantId, userId: CURRENT_USER_ID, content, parentCommentId: parentId };
          const res = await fetchJson(`${apiBase}/create`, {
            method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
          });
          if (res.success) { await loadComments(); }
        });

        if (cmt.replies && cmt.replies.length) {
          cmt.replies.forEach(r => li.appendChild(renderComment(r, depth + 1)));
        }
        return li;
      }

      async function loadComments() {
        listEl.innerHTML = `<div class="text-muted">ƒêang t·∫£i b√¨nh lu·∫≠n...</div>`;
        try {
          const res = await fetchJson(`${apiBase}/${plantId}`);
          listEl.innerHTML = "";
          if (!res.success || !res.data || res.data.length === 0) {
            listEl.innerHTML = `<p class="text-muted">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>`;
            return;
          }
          res.data.forEach(c => listEl.appendChild(renderComment(c)));
          console.log("[Comment] Loaded:", res.data.length);
        } catch (e) {
          console.error("L·ªói t·∫£i b√¨nh lu·∫≠n:", e);
          listEl.innerHTML = `<p class="text-danger">Kh√¥ng th·ªÉ t·∫£i b√¨nh lu·∫≠n.</p>`;
        }
      }

      async function react(commentId, type) {
        const payload = { commentId, userId: CURRENT_USER_ID, reactionType: type };
        const res = await fetchJson(`${apiBase}/react`, {
          method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
        });
        if (res.success) await loadComments();
      }

      btnCreate?.addEventListener("click", async () => {
        const content = txtContent.value.trim();
        if (!content) { alert("Vui l√≤ng nh·∫≠p n·ªôi dung."); return; }
        const payload = { plantId, userId: CURRENT_USER_ID, content };
        const res = await fetchJson(`${apiBase}/create`, {
          method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
        });
        if (res.success) { txtContent.value = ""; await loadComments(); }
        else { alert(res.message ?? "Kh√¥ng th·ªÉ g·ª≠i b√¨nh lu·∫≠n."); }
      });

      loadComments();
    });
    </script>
}
